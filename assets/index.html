<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bird Feed</title>
    </head>
    <body>
        <h1>Bird Feed</h1>
        <h3>
            Aggregated articles and news from around the web about avian
            influenza
        </h3>
        <div id="articles-list"></div>

        <script>
            async function get_dates() {
                try {
                    let response = await fetch("./api/dates");
                    if (!response.ok) {
                        console.log("error fetching dates");
                    }
                    return await response.json();
                } catch (err) {
                    console.log(err);
                }
            }

            async function get_articles_by_date(date) {
                try {
                    let response = await fetch(`./api/articles/${date}`);
                    if (!response.ok) {
                        console.log("error fetching articles for date");
                    }
                    return await response.json();
                } catch (err) {
                    console.log(err);
                }
            }

            async function toggle_date(header, date) {
                const content = header.nextElementSibling;

                if (content.style.display === "block") {
                    content.style.display = "none";
                    return;
                }
                if (content.children.length === 0) {
                    const articles = await get_articles_by_date(date);
                    for (const article of articles) {
                        const li = document.createElement("li");
                        li.innerHTML = `
                                <h4>${article.title}</h4>
                                <a href="${article.link}">${article.link}</a>
                                <p>${article.summary}</p>
                                <p>Published: ${article.date_pub}</p>
                                <p>Source: ${article.source}</p>
                            `;
                        content.appendChild(li);
                    }
                }
                content.style.display = "block";
            }

            async function build_date_list() {
                const dates = await get_dates();
                const container = document.getElementById("articles-list");

                for (const item of dates) {
                    const header = document.createElement("h3");
                    header.textContent = `${item.date} (${item.count} articles)`;
                    header.style.cursor = "pointer";
                    header.addEventListener("click", () =>
                        toggle_date(header, item.date),
                    );
                    container.appendChild(header);
                    const ul = document.createElement("ul");
                    ul.style.display = "none";
                    container.appendChild(ul);
                }
            }
            document.addEventListener("DOMContentLoaded", build_date_list);
        </script>
    </body>
</html>
