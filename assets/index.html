<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bird Feed</title>
    </head>
    <body>
        <h1>Bird Feed</h1>
        <h3>
            Aggregated articles and news from around the web about avian
            influenza
        </h3>
        <div id="articles-list"></div>

        <script>
            async function get_articles() {
                try {
                    let response = await fetch("./api/get_articles");
                    if (!response.ok) {
                        console.log("error fetching articles");
                    }
                    let articles = await response.json();
                    console.log(articles);
                    return articles;
                } catch (err) {
                    console.log(err);
                }
            }
            function group_by_fetched_at(articles) {
                grouped = {};
                for (const article of articles) {
                    const fetched_at = article.fetched_at.split("T")[0];
                    if (!grouped[fetched_at]) {
                        grouped[fetched_at] = [];
                    }
                    grouped[fetched_at].push(article);
                }
                return grouped;
            }
            async function add_articles_to_dom() {
                let articles = await get_articles();
                const grouped = group_by_fetched_at(articles);
                const articles_list = document.getElementById("articles-list");
                const sorted_articles = Object.keys(grouped).sort().reverse();
                for (const date of sorted_articles) {
                    const header = document.createElement("h3");
                    header.textContent = date;
                    articles_list.appendChild(header);

                    const ul = document.createElement("ul");
                    console.log(grouped[date]);
                    for (const article of grouped[date]) {
                        const li = document.createElement("li");
                        li.innerHTML = `
                                                  <h3>${article.title}</h3>
                                                  <a href="${article.link}">${article.link}</a>
                                                  <p>${article.summary}</p>
                                                  <p>Published: ${article.date_pub}</p>
                                                  <p>Source: ${article.source}</p>`;
                        ul.appendChild(li);
                    }
                    articles_list.appendChild(ul);
                }
            }
            document.addEventListener("DOMContentLoaded", add_articles_to_dom);
        </script>
    </body>
</html>
